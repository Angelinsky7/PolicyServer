@model PolicyServer1.Models.Permission

<div x-data="PolicyManager(@Model.Policies.ToJson())" x-init="fetchPolicies()">
	<div class="flex flex-row mb-2">
		<label asp-for="Policies" class="font-bold mb-1 text-gray-700 block text-xs"></label>
		<span class="flex-auto"></span>
	</div>

	<div class="flex flex-row w-full">
		<ul class="flex-1 border border-gray-200 rounded-md m-5 ml-0 select-none overflow-y-auto h-48">
			<template x-for="(scope, index) in availablePolicies" :key="index">
				<li x-on:click="toogleSelect(index, selectedAvailablePolicies, $event)" x-bind:class="{'bg-blue-400': selectedAvailablePolicies.indexOf(index) != -1}" class="pl-3 pr-4 py-3 flex items-center justify-between text-sm leading-5 hover:bg-blue-200">
					<span x-text="scope.name"></span>
				</li>
			</template>
		</ul>
		<div class="w-16 flex flex-col justify-center items-center">
			<button type="button" x-on:click="add()" class="mb-4 disabled:text-gray-400 text-blue-400 focus:outline-none" x-bind:disabled="selectedAvailablePolicies.length == 0">
				<svg class="flex-shrink-0 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
					<use xlink:href="#arrow-outline-right"></use>
				</svg>
			</button>
			<button type="button" x-on:click="remove()" class="disabled:text-gray-400 text-blue-400 focus:outline-none" x-bind:disabled="selectedPolicies.length == 0">
				<svg class="flex-shrink-0 h-5 w-5  " viewBox="0 0 20 20" fill="currentColor">
					<use xlink:href="#arrow-outline-left"></use>
				</svg>
			</button>
		</div>
		<ul class="flex-1 border border-gray-200 rounded-md m-5 mr-0 select-none overflow-y-auto h-48">
			<template x-for="(scope, index) in scopes" :key="index">
				<li x-on:click="toogleSelect(index, selectedPolicies, $event)" x-bind:class="{'bg-blue-400': selectedPolicies.indexOf(index) != -1}" class="pl-3 pr-4 py-3 flex items-center justify-between text-sm leading-5 hover:bg-blue-200">
					<span x-text="scope.name"></span>
				</li>
			</template>
		</ul>
		<div class="hidden">
			<template x-for="(scope, index) in scopes" :key="index">
				<div>
					@*<input type="hidden" x-bind:id="`Policies[${index}].Id`" x-bind:name="`Policies[${index}].Id`" x-bind:value="scope.id" />
					<input type="hidden" x-bind:id="`Policies[${index}].Name`" x-bind:name="`Policies[${index}].Name`" x-bind:value="scope.name" />
					<input type="hidden" x-bind:id="`Policies[${index}].DisplayName`" x-bind:name="`Policies[${index}].DisplayName`" x-bind:value="scope.displayName" />
					<input type="hidden" x-bind:id="`Policies[${index}].IconUri`" x-bind:name="`Policies[${index}].IconUri`" x-bind:value="scope.iconUri" />*@
					<input type="hidden" x-bind:id="`Policies[${index}]`" x-bind:name="`Policies[${index}]`" x-bind:value="scope.id" />
				</div>
			</template>
		</div>
	</div>
	<span asp-validation-for="Policies" class="mt-2 text-sm text-red-800"></span>
</div>

<script>
	function PolicyManager(datas) {
		return {
			availablePolicies: [],
			selectedAvailablePolicies: [],
			scopes: datas.map(p => ({ id: p.Id, name: p.Name, displayName: p.DisplayName, iconUri: p.IconUri })) || [],
			selectedPolicies: [],
			fetchPolicies(resetSelectedPolicies = false) {
				this.availablePolicies = [];

				if (resetSelectedPolicies) {
					this.scopes = [];
				}

				console.log(this.scopes);

				fetch(`/api/policy`)
					.then(response => response.json())
					.then(json => {
						this.availablePolicies = json
							.filter(p => this.scopes.find(a => a.id === p.id) == null)
							.map(p => ({ id: p.id, name: p.name })) || [];
					});
			},
			add() {
				for (var i = this.selectedAvailablePolicies.length - 1; i >= 0; --i) {
					var index = this.selectedAvailablePolicies[i];
					var scope = this.availablePolicies[index];
					this.availablePolicies.splice(index, 1);
					this.scopes.push(scope);
				}
				this.selectedAvailablePolicies.splice(0, this.selectedAvailablePolicies.length);
			},
			remove() {
				for (var i = this.selectedPolicies.length - 1; i >= 0; --i) {
					var index = this.selectedPolicies[i];
					var scope = this.scopes[index];
					this.scopes.splice(index, 1);
					this.availablePolicies.push(scope);
				}
				this.selectedPolicies.splice(0, this.selectedPolicies.length);
			},
			toogleSelect(item, list, event) {
				var index = list.indexOf(item);
				if (!event.ctrlKey) { list.splice(0, list.length); }

				if (index != -1) {
					list.splice(index, 1);
				} else {
					list.push(item);
				}
			}
		};
	}
</script>